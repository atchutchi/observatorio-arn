{% extends "dashboard/base_dashboard.html" %}
{% load static %}
{% load humanize %}

{% block dashboard_title %}Análise Comparativa {{ year }}{% endblock %}

{% block dashboard_content %}
<!-- Header -->
<div class="platform-card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h2 class="card-title mb-0">
                <i class="fas fa-balance-scale me-2"></i>
                Análise Comparativa entre Operadoras
            </h2>
            <p class="card-subtitle">Comparação detalhada - {{ year }}</p>
        </div>
        <div class="export-buttons">
            <a href="#" class="btn-export" data-format="pdf">
                <i class="fas fa-file-pdf"></i> PDF
            </a>
            <a href="#" class="btn-export" data-format="excel">
                <i class="fas fa-file-excel"></i> Excel
            </a>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="dashboard-filters">
    <h5 class="dashboard-filters-title">Período de Análise</h5>
    <form method="get" class="dashboard-filter-group">
        <div class="form-group">
            <label class="form-label">Ano</label>
            <select name="year" class="form-select-questionario dashboard-filter" onchange="this.form.submit()">
                {% for ano in 2020|make_list|add:2021|make_list|add:2022|make_list|add:2023|make_list|add:2024|make_list|add:2025|make_list %}
                <option value="{{ ano }}" {% if ano == year %}selected{% endif %}>{{ ano }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
</div>

<!-- Tabela Comparativa -->
<div class="platform-card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-table me-2"></i>
            Comparação Detalhada
        </h3>
    </div>
    <div class="platform-card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Indicador</th>
                        <th>ORANGE</th>
                        <th>TELECEL</th>
                        <th>Diferença</th>
                    </tr>
                </thead>
                <tbody>
                    {% if comparative_data %}
                        {% for item in comparative_data %}
                        <tr>
                            <td class="fw-bold">{{ item.operadora }}</td>
                            <td>{{ item.assinantes|floatformat:0|default:"--" }}</td>
                            <td>{{ item.market_share|default:"--" }}</td>
                            <td>{{ item.trafego_voz|floatformat:0|default:"--" }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-5">
                                <i class="fas fa-info-circle fa-3x mb-3 d-block"></i>
                                Nenhum dado disponível para o ano selecionado
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Gráficos Comparativos -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="platform-card">
            <div class="card-header">
                <h3 class="card-title">Assinantes por Operadora</h3>
            </div>
            <div class="platform-card-body">
                <canvas id="assinantesChart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="platform-card">
            <div class="card-header">
                <h3 class="card-title">Receitas por Operadora</h3>
            </div>
            <div class="platform-card-body">
                <canvas id="receitasChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="quick-actions mt-4">
    <a href="{% url 'dashboard:market-report' %}?year={{ year }}" class="quick-action">
        <i class="fas fa-chart-area quick-action-icon"></i>
        <span>Relatório de Mercado</span>
    </a>
    
    <a href="{% url 'dashboard:executive-dashboard' %}?year={{ year }}" class="quick-action">
        <i class="fas fa-crown quick-action-icon"></i>
        <span>Dashboard Executivo</span>
    </a>
    
    <a href="{% url 'dashboard:report-history' %}" class="quick-action">
        <i class="fas fa-history quick-action-icon"></i>
        <span>Histórico</span>
    </a>
</div>
{% endblock %}

{% block dashboard_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const comparativeData = {{ comparative_data|safe|default:"[]" }};
    
    if (comparativeData && comparativeData.length > 0) {
        // Gráfico de Assinantes
        const assinantesCtx = document.getElementById('assinantesChart');
        if (assinantesCtx) {
            new Chart(assinantesCtx, {
                type: 'bar',
                data: {
                    labels: comparativeData.map(item => item.operadora),
                    datasets: [{
                        label: 'Assinantes',
                        data: comparativeData.map(item => item.assinantes),
                        backgroundColor: ['rgba(255, 102, 0, 0.7)', 'rgba(220, 53, 69, 0.7)'],
                        borderColor: ['#FF6600', '#DC3545'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#F0F0F0' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#F0F0F0' }
                        }
                    }
                }
            });
        }
        
        // Gráfico de Receitas
        const receitasCtx = document.getElementById('receitasChart');
        if (receitasCtx) {
            new Chart(receitasCtx, {
                type: 'doughnut',
                data: {
                    labels: comparativeData.map(item => item.operadora),
                    datasets: [{
                        data: comparativeData.map(item => item.receitas),
                        backgroundColor: ['rgba(255, 102, 0, 0.7)', 'rgba(220, 53, 69, 0.7)'],
                        borderColor: ['#FF6600', '#DC3545'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#F0F0F0' }
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}

